generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
}

model User {
  id               String   @id @default(uuid())
  email            String   @unique
  name             String
  password         String
  referralCode     String   @unique
  tier             String   @default("Member")
  storeCredit      Float    @default(0)
  referralCount    Int      @default(0)
  // Referral relationships (self relation)
  referrerId       String?
  referrer         User?    @relation("UserReferrals", fields: [referrerId], references: [id])
  referrals        User[]   @relation("UserReferrals")

  // Relations
  orders            Order[]
  commissionsEarned Commission[] @relation("ReferrerCommissions")
  commissionsFrom   Commission[] @relation("BuyerCommissions")
  checkoutSessions  CheckoutSession[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Product {
  id         Int      @id @default(autoincrement())
  name       String
  sizes      Json     // [{ mg: Int, price: Float }]
  desc       String
  details    String   @db.Text
  references Json     // [{ url: String, title: String }]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model CheckoutSession {
  id                  Int      @id @default(autoincrement())
  sessionId           String   @unique

  userId              String
  user                User     @relation(fields: [userId], references: [id])

  items               Json
  originalSubtotal    Float
  discountedSubtotal  Float
  discount            Float
  shipping            Float
  storeCreditsApplied Float
  total               Float

  shippingName        String
  shippingAddress     String

  status              String   @default("pending")
  orderId             Int?

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([userId])
  @@index([sessionId])
}

model Order {
  id                     Int      @id @default(autoincrement())

  userId                 String
  user                   User     @relation(fields: [userId], references: [id])

  items                  Json
  originalSubtotal       Float
  subtotal               Float
  discount               Float
  shipping               Float
  storeCreditsApplied    Float
  total                  Float

  shippingName           String
  shippingAddress        String

  stripeSessionId        String?  @unique
  stripePaymentIntentId String?

  status                 String   @default("pending") 
  // pending | processing | shipped | completed | cancelled

  commissions            Commission[]

  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Commission {
  id          Int      @id @default(autoincrement())

  referrerId  String
  referrer    User     @relation("ReferrerCommissions", fields: [referrerId], references: [id])

  buyerId     String
  buyer       User     @relation("BuyerCommissions", fields: [buyerId], references: [id])

  orderId     Int
  order       Order    @relation(fields: [orderId], references: [id])

  amount      Float

  createdAt   DateTime @default(now())

  @@index([referrerId])
  @@index([buyerId])
  @@index([orderId])
}