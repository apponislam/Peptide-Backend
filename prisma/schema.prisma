generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum UserTier {
  Member
  Founder
  VIP
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  CANCELLED
}

enum StripePaymentStatus {
  PENDING
  PAID
  FAILED
}

enum CommissionStatus {
  PENDING
  PAID
  FAILED
}

model User {
  id               String   @id @default(uuid())
  email            String   @unique
  name             String
  password         String
  referralCode     String   @unique
  tier             UserTier @default(Member)
  role             UserRole @default(USER)

  // Soft delete
  isActive         Boolean  @default(true)
  deletedAt        DateTime?

  storeCredit      Float    @default(0)
  referralCount    Int      @default(0)

    // Shipping Credit System - ONLY used for Members
  shippingCredit   Float    @default(150.00)

  isReferralValid  Boolean  @default(false)
  referrerId       String?
  referrer         User?    @relation("UserReferrals", fields: [referrerId], references: [id])
  referrals        User[]   @relation("UserReferrals")

  // Relations
  orders            Order[]
  commissionsEarned Commission[] @relation("ReferrerCommissions")
  commissionsFrom   Commission[] @relation("BuyerCommissions")
  checkoutSessions  CheckoutSession[]

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([email])
  @@index([referrerId])
  @@index([tier])
}

model Product {
  id         Int      @id @default(autoincrement())
  name       String
  sizes      Json
  desc       String
  details    String   @db.Text
  references Json
  coa        Json?

  isDeleted   Boolean  @default(false)
  deletedAt  DateTime?

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

    orderItems OrderItem[]

  @@index([isDeleted])
  @@index([createdAt])
  @@index([name])
}

model Order {
  id                String      @id @default(uuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id])

  // Shipping Info
  name              String
  email             String
  phone             String
  address           String
  city              String
  state             String
  zip               String
  country           String

  // Pricing
  originalPrice     Float
  discountPercentage Float
  discountAmount    Float
  subtotal          Float
  shipping          Float
  creditApplied     Float
  total             Float

  status            OrderStatus @default(PENDING)

  // ShipStation Data
  shipstationOrderId Int?
  trackingNumber    String?
  labelUrl          String?

  // Commission
  commissionAmount  Float?     @default(0)
  commissionPaid    Boolean    @default(false)

  items             OrderItem[]
  commissions       Commission[]

  checkoutSessions  CheckoutSession[]

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([trackingNumber])
  @@index([email])
  @@index([shipstationOrderId])
}


model OrderItem {
  id              String  @id @default(uuid())
  orderId         String
  order           Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId       Int?
  product         Product? @relation(fields: [productId], references: [id])

  quantity        Int
  unitPrice       Float
  discountedPrice Float

  @@index([orderId])
  @@index([productId])
}

model CheckoutSession {
  id              String   @id @default(uuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])

  orderId         String?
  order           Order?   @relation(fields: [orderId], references: [id])

  stripeSessionId String @unique
  paymentStatus   StripePaymentStatus @default(PENDING)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([orderId])
  @@index([stripeSessionId])
  @@index([paymentStatus])
}

model Commission {
  id          String   @id @default(uuid())

  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  referrerId  String
  referrer    User     @relation("ReferrerCommissions", fields: [referrerId], references: [id])

  buyerId     String
  buyer       User     @relation("BuyerCommissions", fields: [buyerId], references: [id])

  amount      Float
  status      CommissionStatus @default(PENDING)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([orderId])
  @@index([referrerId])
  @@index([buyerId])
  @@index([status])
  @@index([createdAt])
}
